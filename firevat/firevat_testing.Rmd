---
title: "firevat_testing"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(FIREVAT)
library(tidyverse)
library(bedr)
library(stringr)
library(MutationalPatterns)
library(BSgenome)
ref_genome <- "BSgenome.Hsapiens.UCSC.hg19"
library(ref_genome, character.only = TRUE)
library(ROCR)

source("../simulation.R")
source("../sample_conversions.R")

seq <- getSeq(Hsapiens, "chr1")
```

```{r}
run <- function(signature = "SBS6", default = 0) {
  
  if (default == 0) {
    # Run FIREVAT
    results <- RunFIREVAT(vcf.file = sample.vcf.file,
                          vcf.file.genome = 'hg38', # for mouse variants: 'mm10'
                          config.file = config.file,
                          df.ref.mut.sigs = df.sigs,
                          target.mut.sigs = c(signature, "ffpe.sig"),
                          sequencing.artifact.mut.sigs = c("ffpe.sig"),
                          output.dir = output.dir,
                          objective.fn = Default.Obj.Fn,
                          num.cores = 2,
                          ga.pop.size = 100,
                          ga.max.iter = 5,
                          ga.run = 5,
                          perform.strand.bias.analysis = FALSE,
                          annotate = FALSE)
  } else if (default == 1) {
    # Run FIREVAT
    results <- RunFIREVAT(vcf.file = sample.vcf.file,
                          vcf.file.genome = 'hg19', # for mouse variants: 'mm10'
                          config.file = config.file,
                          df.ref.mut.sigs = GetPCAWGMutSigs(),
                          target.mut.sigs = GetPCAWGMutSigsNames(),
                          sequencing.artifact.mut.sigs = PCAWG.All.Sequencing.Artifact.Signatures,
                          output.dir = output.dir,
                          objective.fn = Default.Obj.Fn,
                          num.cores = 2,
                          ga.pop.size = 100,
                          ga.max.iter = 5,
                          ga.run = 5,
                          perform.strand.bias.analysis = FALSE,
                          annotate = FALSE)
  }
}

get_roc_point <- function(df) {
  tp <- df %>%
    filter(truth == classify, classify != "FFPE") %>%
    count()
  tp <- tp$n
  
  tn <- df %>%
    filter(truth == classify, classify == "FFPE") %>%
    count()
  tn <- tn$n
  
  fp <- df %>%
    filter(truth != classify, classify != "FFPE") %>%
    count()
  fp <- fp$n
  
  fn <- df %>%
    filter(truth != classify, classify == "FFPE") %>%
    count()
  fn <- fn$n
  
  tpr <- tp / (tp + fn)
  fpr <- fp / (fp + tn)
  
  return(c(fpr, tpr))
}
```

```{r}
cosmic.sigs <- get_known_signatures()
cosmic.sig6 <- as.matrix(cosmic.sigs[,6])
cosmic.sig4 <- as.matrix(cosmic.sigs[,4])
ffpe.sig <- as.matrix(load_old_mutational_matrix("../ROC_Curves/supplied_results/ffpe.signature.txt", "../supplied_results/mut_sig.order.txt")) # Doesn't work

df.sigs <- data.frame(GetPCAWGMutSigs()[1:3], cosmic.sigs, ffpe.sig)
rownames(df.sigs) <- seq(1, 96)
```


```{r}
sample.sig6 <- create_signature_sample_vector(cosmic.sig6, 100)
sample.ffpe <- create_signature_sample_vector(ffpe.sig, 100)

sample1.df <- get_classification_df(list(sample.sig6, sample.ffpe), c("MMR", "FFPE"), list(cosmic.sig6, ffpe.sig))

write_sample_to_vcf(sample1.df, "sample1.vcf", Hsapiens, "chr1")

sample.vcf.file <- "sample1.vcf"
config.file <- "../custom_config.json"
output.dir <- "./"

run("SBS6")
```

```{r}
sample1.firevat.df <- create_classify_df("sample1.vcf", seq)

mean(sample1.firevat.df$misclassification)
mean(sample1.df$misclassification)

roc.point <- get_roc_point(sample1.firevat.df)
get_roc_point(sample1.df)

sample1.df <- sample1.df %>%
  mutate(binaryTruth = ifelse(truth == "MMR", 1, 0))

sample1.prediction <- prediction(sample1.df$MMR, sample1.df$binaryTruth)
sample1.perf <- performance(sample1.prediction, "tpr", "fpr")
plot(sample1.perf)
points(x=roc.point[1], y=roc.point[2])
```

```{r}
sample.sig6 <- create_signature_sample_vector(cosmic.sig6, 500)
sample.ffpe <- create_signature_sample_vector(ffpe.sig, 500)

sample2.df <- get_classification_df(list(sample.sig6, sample.ffpe), c("MMR", "FFPE"), list(cosmic.sig6, ffpe.sig))

write_sample_to_vcf(sample2.df, "sample2.vcf", Hsapiens, "chr1")

sample.vcf.file <- "sample2.vcf"
config.file <- "../custom_config.json"
output.dir <- "./"

run("SBS6")
```

```{r}
sample2.firevat.df <- create_classify_df("sample2.vcf", seq)

mean(sample2.firevat.df$misclassification)
mean(sample2.df$misclassification)

roc.point <- get_roc_point(sample2.firevat.df)
get_roc_point(sample2.df)

sample2.df <- sample2.df %>%
  mutate(binaryTruth = ifelse(truth == "MMR", 1, 0))

sample2.prediction <- prediction(sample2.df$MMR, sample2.df$binaryTruth)
sample2.perf <- performance(sample2.prediction, "tpr", "fpr")
plot(sample2.perf)
points(x=roc.point[1], y=roc.point[2])
```

```{r}
sample.sig4 <- create_signature_sample_vector(cosmic.sig4, 100)
sample.ffpe <- create_signature_sample_vector(ffpe.sig, 100)

sample3.df <- get_classification_df(list(sample.sig4, sample.ffpe), c("MMR", "FFPE"), list(cosmic.sig4, ffpe.sig))

write_sample_to_vcf(sample3.df, "sample3.vcf", Hsapiens, "chr1")

sample.vcf.file <- "sample3.vcf"
config.file <- "../custom_config.json"
output.dir <- "./"

run("SBS4")
```

```{r}
sample3.firevat.df <- create_classify_df("sample3.vcf", seq)

mean(sample3.firevat.df$misclassification)
mean(sample3.df$misclassification)

roc.point <- get_roc_point(sample3.firevat.df)
get_roc_point(sample3.df)

sample3.df <- sample3.df %>%
  mutate(binaryTruth = ifelse(truth == "MMR", 1, 0))

sample3.prediction <- prediction(sample3.df$MMR, sample3.df$binaryTruth)
sample3.perf <- performance(sample3.prediction, "tpr", "fpr")
plot(sample3.perf)
points(x=roc.point[1], y=roc.point[2])
```

```{r}
sample.sig4 <- create_signature_sample_vector(cosmic.sig4, 500)
sample.ffpe <- create_signature_sample_vector(ffpe.sig, 500)

sample4.df <- get_classification_df(list(sample.sig4, sample.ffpe), c("MMR", "FFPE"), list(cosmic.sig4, ffpe.sig))

write_sample_to_vcf(sample4.df, "sample4.vcf", Hsapiens, "chr1")

sample.vcf.file <- "sample4.vcf"
config.file <- "../custom_config.json"
output.dir <- "./"

run("SBS4")
```

```{r}
sample4.firevat.df <- create_classify_df("sample4.vcf", seq)

mean(sample4.firevat.df$misclassification)
mean(sample4.df$misclassification)

roc.point <- get_roc_point(sample4.firevat.df)
get_roc_point(sample4.df)

sample4.df <- sample4.df %>%
  mutate(binaryTruth = ifelse(truth == "MMR", 1, 0))

sample4.prediction <- prediction(sample4.df$MMR, sample4.df$binaryTruth)
sample4.perf <- performance(sample4.prediction, "tpr", "fpr")
plot(sample4.perf)
points(x=roc.point[1], y=roc.point[2])
```












