---
title: "Abstract Plots"
author: "Audrey Mitchell"
date: "7/21/2021"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(NMF)
library(MutationalPatterns)
library(tidyverse)
library(ggrepel)
library(ROCR)
source("bayes_function.R")
source("get_classification_df.R")
source("simulation.R")
```

```{r}
vector_to_matrix <- function(mutations.vector){
  tab <- table(mutations.vector)/sum(table(mutations.vector))
  #transform table to a data frame and assign column names to mutations and frequencies
  mutations.df <- data.frame(tab)
  colnames(mutations.df) <- c("mutations", "frequencies")
  
  #defines a function that joins two data frames and replaces NA with 0
  left_join_NA <- function(x, y, by) {
    left_join(x = x, y = y, by = by) %>% 
      mutate_each(funs(replace(., which(is.na(.)), 0)))
  }
  
  #converts vector of 96 mutation types to a data frame
  mutation.types.df <- data.frame(mutations)
  #joins together sample probabilities with data frame of mutation types so that all 96 mutation types are included
  complete.mutations.df <- left_join_NA(mutation.types.df, mutations.df, by = "mutations")
  
  #converts data frame of mutation types and frequencies to a data frame and assigns rownames
  mutations.matrix <- as.matrix(complete.mutations.df$frequencies)
  rownames(mutations.matrix) = mutations
  
  return(mutations.matrix)
}
```


```{r}
#load FFPE signature as a matrix
ffpe.signature <- as.matrix(load_old_mutational_matrix("supplied_results/ffpe.signature.txt"))

#create vector of the 96 mutation types
mutations <- rownames(ffpe.signature) 

#Load COSMIC signatures (version 3)
cosmic.signatures <- get_known_signatures(muttype = "snv")

#Create vector of the signature names
signature.names <- colnames(cosmic.signatures)

#Create list of signature matrices with assigned rownames
signature.matrix.list <- list()
for (i in 1:length(signature.names)){
  sig <- cosmic.signatures[,i]
  sig.mat <- as.matrix(sig)
  rownames(sig.mat) <- mutations
  colnames(sig.mat) <- signature.names[i]
  signature.matrix.list[[i]] <- sig.mat
}

#create vector of cosine similarities to the FFPE signature
ffpe.cosmic.cos.sims <- c()
for (i in 1:length(signature.names)){
  cos.sim <- cos_sim_matrix(signature.matrix.list[[i]], ffpe.signature)
  ffpe.cosmic.cos.sims[i] <- cos.sim[1,1]
}

signature.4.mat <- as.matrix(cosmic.signatures[,"SBS4"])
rownames(signature.4.mat) <- mutations

signature.6.mat <- as.matrix(cosmic.signatures[,"SBS6"])
rownames(signature.6.mat) <- mutations
```

#Diagram of Methods

```{r}
mmr.sample <- create_signature_sample_vector(signature.6.mat, 200)
tobacco.sample <- create_signature_sample_vector(signature.4.mat, 200)
ffpe.sample <- create_signature_sample_vector(ffpe.signature, 100)

ex.ffpe.profile.mat <- vector_to_matrix(c(mmr.sample, tobacco.sample, ffpe.sample))
rownames(ex.ffpe.profile.mat) <- mutations
colnames(ex.ffpe.profile.mat) <- c("Sample 1")

mut.profile <- plot_96_profile(ex.ffpe.profile.mat)+
  labs(title = "Mutational Profile", x = "Context")+
  theme(plot.title = element_text(hjust = 0.5))

mut.profile

ggsave("mutprofile.png", plot = mut.profile , width = 175, height = 108, units = "mm")
```

```{r}
sig.mat <- cbind(signature.4.mat, signature.6.mat, ffpe.signature)
colnames(sig.mat) <- c("Signature 4", "Signature 6", "FFPE")
fts.res <- fit_to_signatures(ex.ffpe.profile.mat, sig.mat)

contribution.plot <- plot_contribution(fts.res$contribution, sig.mat, coord_flip = TRUE)+
  labs(title = "Relative Contributions of Signatures")+
  theme(plot.title = element_text(hjust = 0.5))

contribution.plot

ggsave("contributions.png", plot = contribution.plot , width = 175, height = 54, units = "mm")
```

```{r}
signatures.plot <- plot_96_profile(sig.mat)+
  labs(title = "Mutational Signatures", x = "Context")+
  theme(plot.title = element_text(hjust = 0.5))

signatures.plot

ggsave("signatures.png", plot = signatures.plot , width = 175, height = 108, units = "mm")
```

#Diagram of Simulating Data
```{r}
signature4.plot <- plot_96_profile(signature.4.mat)+
  labs(title = "Signature 4", x = "Context")+
  theme(plot.title = element_text(hjust = 0.5))

ggsave("signature4.png", plot = signature4.plot , width = 175, height = 81, units = "mm")
```

```{r}
ffpe.plot <- plot_96_profile(ffpe.signature)+
  labs(title = "FFPE Signature", x = "Context")+
  theme(plot.title = element_text(hjust = 0.5))

ggsave("ffpe.png", plot = ffpe.plot , width = 175, height = 81, units = "mm")
```

```{r}
sample.4 <- create_signature_sample_vector(signature.4.mat, 500)
sample.ffpe <- create_signature_sample_vector(ffpe.signature, 500)

ex.sim.sample.vec <- c(sample.4, sample.ffpe)
ex.sim.sample <- vector_to_matrix(ex.sim.sample.vec)

sampleprof.plot <- plot_96_profile(ex.sim.sample)+
  labs(title = "Simulated Sample Profile", x = "Context")+
  theme(plot.title = element_text(hjust = 0.5))

sampleprof.plot

ggsave("sampleprofile.png", plot = sampleprof.plot , width = 175, height = 108, units = "mm")
```

#Reconstructed Profiles of Signatures 4 and 6

```{r}
#Create Signature 4 Sample
sig4.500 <- create_signature_sample_vector(signature.4.mat, 500)
sig4.profile <- vector_to_matrix(sig4.500)

sig4.profile.plot <- plot_96_profile(sig4.profile)+
  labs(title = "Signature 4 Simulated Sample", x = "Context")+
  theme(plot.title = element_text(hjust = 0.5))

sig4.profile.plot
```

```{r}
#Add FFPE Noise
addffpe.500 <- create_signature_sample_vector(ffpe.signature, 500)

sig4.ffpe <- vector_to_matrix(c(sig4.500, addffpe.500))

sig4.ffpe.plot <- plot_96_profile(sig4.ffpe)+
  labs(title = "Simulated Sample with FFPE Noise", x = "Context")+
  theme(plot.title = element_text(hjust = 0.5))
```

```{r}
#Classify and Filter
sig4.ffpe.class <- get_classification_df(list(sig4.500, addffpe.500), c("SBS4", "FFPE"), list(signature.4.mat, ffpe.signature))

sig4.ffpe.filtered <- sig4.ffpe.class %>%
  filter(classify != "FFPE")

sig4.recon.matrix <- vector_to_matrix(sig4.ffpe.filtered$mutations)

sig4.recon.plot <- plot_96_profile(sig4.recon.matrix)+
  labs(title = "Signature 4 Reconstructed", x = "Context")+
  theme(plot.title = element_text(hjust = 0.5))

sig4.recon.plot
```

```{r}
#Calculate Sensitivity, Specificity, and Misclassification rate

sig4.sensitivity <- sig4.ffpe.class %>%
  filter(truth == "SBS4" & classify == "SBS4")

nrow(sig4.sensitivity)/500

sig4.specificity <- sig4.ffpe.class %>%
  filter(truth == "FFPE" & classify == "FFPE")

nrow(sig4.specificity)/500

mean(sig4.ffpe.class$misclassification)
```

```{r}
#Arrange 3 plots
sig4.reconstruction <- grid.arrange(sig4.profile.plot, sig4.ffpe.plot, sig4.recon.plot)

ggsave("sig4reconstruction.png", plot = sig4.reconstruction , width = 175, height = 243, units = "mm")
```

```{r}
#Create Signature 6 Sample
sig6.500 <- create_signature_sample_vector(signature.6.mat, 500)
sig6.profile <- vector_to_matrix(sig6.500)

sig6.profile.plot <- plot_96_profile(sig6.profile)+
  labs(title = "Signature 6 Simulated Sample", x = "Context")+
  theme(plot.title = element_text(hjust = 0.5))

sig6.profile.plot
```

```{r}
#Add FFPE Noise
sig6.ffpe <- vector_to_matrix(c(sig6.500, addffpe.500))

sig6.ffpe.plot <- plot_96_profile(sig6.ffpe)+
  labs(title = "Simulated Sample with FFPE Noise", x = "Context")+
  theme(plot.title = element_text(hjust = 0.5))

sig6.ffpe.plot
```

```{r}
#Classify and Filter
sig6.ffpe.class <- get_classification_df(list(sig6.500, addffpe.500), c("SBS6", "FFPE"), list(signature.6.mat, ffpe.signature))

sig6.ffpe.filtered <- sig6.ffpe.class %>%
  filter(classify != "FFPE")

sig6.recon.matrix <- vector_to_matrix(sig6.ffpe.filtered$mutations)

sig6.recon.plot <- plot_96_profile(sig6.recon.matrix)+
  labs(title = "Signature 6 Reconstructed", x = "Context")+
  theme(plot.title = element_text(hjust = 0.5))

sig6.recon.plot
```

```{r}
#Calculate Sensitivity, specificity, and misclassification rate

sig6.sensitivity <- sig6.ffpe.class %>%
  filter(truth == "SBS6" & classify == "SBS6")

nrow(sig6.sensitivity)/500

sig6.specificity <- sig6.ffpe.class %>%
  filter(truth == "FFPE" & classify == "FFPE")

nrow(sig6.specificity)/500

mean(sig6.ffpe.class$misclassification)
```

```{r}
#Arrange 3 plots
sig6.reconstruction <- grid.arrange(sig6.profile.plot, sig6.ffpe.plot, sig6.recon.plot)

ggsave("sig6reconstruction.png", plot = sig6.reconstruction , width = 175, height = 243, units = "mm")
```

# ROC curve

```{r}
sample.sig6 <- create_signature_sample_vector(signature.6.mat, 500)
sig6.truth <- rep("MMR", 500)
sample.ffpe <- create_signature_sample_vector(ffpe.signature, 500)
ffpe.truth <- rep("FFPE", 500)
MMR.ROC <- get_classification_df(list(sample.sig6, sample.ffpe), c("MMR","FFPE"),
                              list(signature.matrix.list[[6]], ffpe.sig))

sample.sig4 <- create_signature_sample_vector(signature.4.mat, 500)
sig4.truth <- rep("Tobacco", 500)
tob.ROC <- get_classification_df(list(sample.sig4, sample.ffpe), c("Tobacco","FFPE"),
                              list(signature.matrix.list[[4]], ffpe.sig))
```

```{r}
MMR.ROC <- MMR.ROC %>%
  #create binary labels
  mutate(truthMMR = ifelse(truth == "MMR",1,0))

tob.ROC <- tob.ROC %>%
  mutate(truthTob = ifelse(truth == "Tobacco",1,0))

#provide predictions and labels
MMR.pred <- prediction(MMR.ROC$MMR, MMR.ROC$truthMMR)
MMR.perf <- performance(MMR.pred, measure = "tpr", x.measure = "fpr")
tob.pred <- prediction(tob.ROC$Tobacco, tob.ROC$truthTob)
tob.perf <- performance(tob.pred, measure = "tpr", x.measure = "fpr")
plot(MMR.perf, print.cutoffs.at=0.5, text.adj=c(-0.2,1.7),
     main = "ROC curve of classifier", lty = 2) #ROC
plot(tob.perf, print.cutoffs.at=0.5, text.adj=c(-0.2,1.7), 
     add = TRUE, lty = 3)
abline(a=0, b= 1)
legend("bottom", c("Signature 6 with FFPE noise", "Signature 4 with FFPE noise"),
       lty = 2:3)
```


#Scatterplot of Average AUC vs. Cosine Similarity to FFPE
```{r}
#outer for loop: loop through each COSMIC v3 signature
average.auc.values <- c()
for (x in 1:length(signature.names)){
  signature.auc.vec <- c()
  #inner for loop: calculate misclassification rate 10x for each signature
  for (y in 1:10){
    #create a sample vector of 100 mutations for the COSMIC signature corresponding to number x
    sample.vec <- create_signature_sample_vector(signature.matrix.list[[x]],500)
    #Create FFPE sample vector of 100 mutations
    ffpe.sample.vec <- create_signature_sample_vector(ffpe.signature, 100)
    classification.df.1 <- get_classification_df(list(sample.vec, ffpe.sample.vec), c(signature.names[x],"FFPE"), list(signature.matrix.list[[x]], ffpe.signature))
    class.df.colnames <- colnames(classification.df.1)
    sig.name <- class.df.colnames[3]
    classification.df.2 <- classification.df.1 %>%
      mutate(signature.indicator = ifelse(truth == sig.name, 1, 0))
    predictions <- classification.df.2[3]
    labels <- classification.df.2$signature.indicator
    pred <- prediction(predictions, labels)
    auc.perf <- performance(pred, measure = "auc")
    signature.auc.vec[y] <- auc.perf@y.values[[1]][1]
  }
  average.signature.auc <- mean(signature.auc.vec)
  average.auc.values[x] <- average.signature.auc
}
```

```{r}
cos.sim.auc.data <- data.frame(signature.names, ffpe.cosmic.cos.sims, average.auc.values)
colnames(cos.sim.auc.data) <- c("signature", "cosine_similarity", "average_auc")
```

```{r}
model2 <- lm(average_auc ~ cosine_similarity, data = cos.sim.auc.data)

#summary(model2)

model2_summary <- summary(model2)

cos.sim.auc.data$residuals <- model2_summary$residuals

cos.sim.auc.outliers <- cos.sim.auc.data %>%
  filter(residuals >= quantile(cos.sim.auc.data$residuals, 0.90) | 
         residuals <= quantile(cos.sim.auc.data$residuals, 0.10) |
           signature %in% c("SBS4"))
```

```{r}
ggplot(cos.sim.auc.data, aes(x = cosine_similarity, y = average_auc))+
  geom_point()+
  geom_smooth(method = "lm")+
  labs(title = "Average area under curve vs. cosine similarity to FFPE", x = "Cosine similarity of COSMIC signature to FFPE signature", y = "Average area under curve (10 iterations)")+
  geom_point(data = cos.sim.auc.outliers, color = "red")+
  geom_label_repel(data = cos.sim.auc.outliers, aes(label = signature), max.overlaps = 10, label.size =   0.1)
  
```

#Scatterplot of Average Sensitivity and Specificity vs. Cosine Similarity to FFPE

```{r}
#outer for loop: loop through each COSMIC v3 signature
average.sensitivity.values <- c()
average.specificity.values <- c()
for (x in 1:length(signature.names)){
  signature.sensitivity.vec <- c()
  signature.specificity.vec <- c()
  #inner for loop: calculate misclassification rate 10x for each signature
  for (y in 1:10){
    #create a sample vector of 100 mutations for the COSMIC signature corresponding to number x
    sample.vec <- create_signature_sample_vector(signature.matrix.list[[x]],100)
    #Create FFPE sample vector of 100 mutations
    ffpe.sample.vec <- create_signature_sample_vector(ffpe.signature, 100)
    classification.df <- get_classification_df(list(sample.vec, ffpe.sample.vec), c(signature.names[x],"FFPE"), list(signature.matrix.list[[x]], ffpe.signature))
    class.df.colnames <- colnames(classification.df)
    sig.name <- class.df.colnames[3]
    #Count number of true positives (for sensititivity)
    sensitivity.df <- classification.df %>%
      filter(truth == sig.name & classify == sig.name)
    #Calculate sensitivity
    sensitivity.val = nrow(sensitivity.df)/100
    #Add to the vector of 10 sensitivity values
    signature.sensitivity.vec[y] = sensitivity.val
    #Count number of true negatives (for specificity)
    specificity.df <- classification.df %>%
      filter(truth == "FFPE" & classify == "FFPE")
    #Calculate specificity
    specificity.val = nrow(specificity.df)/100
    #Add to the vector of 10 specificity values
    signature.specificity.vec[y] = specificity.val
  }
  average.signature.sensitivity <- mean(signature.sensitivity.vec)
  average.sensitivity.values[x] <- average.signature.sensitivity
  average.signature.specificity <- mean(signature.specificity.vec)
  average.specificity.values[x] <- average.signature.specificity
}
```

```{r}
sens.spec.data <- data.frame(signature.names, ffpe.cosmic.cos.sims, average.sensitivity.values, average.specificity.values)

colnames(sens.spec.data) <- c("signature", "cosine_similarity", "sensitivity", "specificity")

sens.spec.data.2 <- sens.spec.data %>%
  pivot_longer(c(sensitivity, specificity), names_to = "measure", values_to = "value")
```

```{r}
ggplot(data = sens.spec.data.2, aes(x = cosine_similarity, y = value, color = measure))+
  geom_point()+
  geom_smooth(method = lm, se = FALSE)+
  labs(title = "Sensitivity & Specificity vs. Cosine Similarity to FFPE Signature", x = "Cosine Similarity of COSMIC Signature to FFPE", y = "Average Sensitivity and Specificity (10 iterations)")
```


# Dilution performance characteristics 

```{r}
cosmic.sig4 = signature.matrix.list[[4]]
cosmic.sig6 = signature.matrix.list[[6]]
ffpe.sig = ffpe.signature
```


## Dilution predictions

```{r}
num.mut = 1000
step = seq(50, 950, by = 50)
```


```{r}
probabilities.MMR <- vector(mode = "list", length = length(step))
truth.MMR <- vector(mode = "list", length = length (step))

for (x in 1:length(step)){
  sample.ffpe <- create_signature_sample_vector(ffpe.sig, step[x])
  ffpe.truth <- rep("FFPE", step[x])
  sample.sig6 <- create_signature_sample_vector(cosmic.sig6, num.mut-step[x])
  sig6.truth <- rep("MMR", num.mut-step[x])
  test <- get_classification_df(list(sample.sig6, sample.ffpe), c("MMR","FFPE"),
                                list(cosmic.sig6, ffpe.sig))
  classification <- test %>%
    mutate(trueBinary = ifelse(truth == "MMR",1,0))

  probabilities.MMR[[x]] <- classification$MMR
  truth.MMR[[x]] <- classification$trueBinary
}
```

```{r}
probabilities.tob <- vector(mode = "list", length = length(step))
truth.tob <- vector(mode = "list", length = length(step))

for (x in 1:length(step)){
  sample.ffpe <- create_signature_sample_vector(ffpe.sig, step[x])
  ffpe.truth <- rep("FFPE", step[x])
  sample.sig4 <- create_signature_sample_vector(cosmic.sig4, num.mut-step[x])
  sig4.truth <- rep("Tobacco", num.mut-step[x])
  test <- get_classification_df(list(sample.sig4, sample.ffpe), c("Tobacco","FFPE"),
                                list(cosmic.sig4, ffpe.sig))
  classification <- test %>%
    mutate(trueBinary = ifelse(truth == "Tobacco",1,0))

  probabilities.tob[[x]] <- classification$Tobacco
  truth.tob[[x]] <- classification$trueBinary
}
```


```{r}
test.MMR <- prediction(probabilities.MMR, truth.MMR)
test.tob <- prediction(probabilities.tob, truth.tob)
```

```{r}
evaluate_perf <- function(num_iter, length, pred_obj, perf_method){
  AVG.sens <- vector(mode = "list", length = length)
  
  for (iteration in 1:num_iter){
  sens.obj <- performance(pred_obj, measure = perf_method)
  
  for(ind in 1:length(sens.obj@x.values)){
    thresh = as.vector(slot(sens.obj, "x.values")[[ind]])
    sens = as.vector(slot(sens.obj, "y.values")[[ind]])
    if (length(thresh) > 2){
      if (identical(which(thresh<=0.5), integer(0))){
        AVG.sens[[ind]][iteration] = NA
      }
      else{
        low.ind = max(which(thresh >=0.5))
        high.ind = min(which(thresh <=0.5))
        #point slop formula of a line
        slope = (sens[high.ind] - sens[low.ind]) / (thresh[high.ind] - thresh[low.ind])
        AVG.sens[[ind]][iteration] = slope*(0.5 - thresh[low.ind]) + sens[low.ind]
      }
    }
    else{
      AVG.sens[[ind]][iteration] = NA
        }
      }
    }

  sens.vec = c()
  for (avg in 1:length(AVG.sens)){
    sens.vec[avg] = mean(AVG.sens[[avg]], na.rm = TRUE)
  }
  
  return(sens.vec)
}
```

## Sensitivity

```{r}
sens.MMR.vec = evaluate_perf(100, length(step), test.MMR, "sens")
```

```{r}
sens.tob.vec = evaluate_perf(100, length(step), test.tob, "sens")
```

### Sensitivity plot

```{r}
sensitivity = append(sens.MMR.vec, sens.tob.vec)
signature.sens = append(rep("Signature 6", length(sens.MMR.vec)),
                        rep("Signature 4", length(sens.tob.vec)))
dilution = append(step/10, step/10)
sens.df <- data.frame(dilution, sensitivity, signature.sens)

ggplot(data = sens.df, mapping = aes(x = dilution, 
                                     y = sensitivity, 
                                     color = signature.sens)) +
  geom_point() +
  geom_smooth() +
  labs(title = "Sensitivity as a function of FFPE noise",
       x = "Percent of FFPE noise in samples",
       y = "Sensitivity value",
       color = "True signal") +
  coord_cartesian(xlim = c(0,100), ylim = c(0,1))
```

## Specificity

```{r}
spec.MMR.vec = evaluate_perf(100, length(step), test.MMR, "spec")
spec.tob.vec = evaluate_perf(100, length(step), test.tob, "spec")
```

### Specificity plot

```{r}
specificity = append(spec.MMR.vec, spec.tob.vec)
signature.spec = append(rep("Signature 6", length(sens.MMR.vec)),
                        rep("Signature 4", length(spec.tob.vec)))
dilution = append(step/10, step/10)
spec.df <- data.frame(dilution, specificity, signature.spec)

ggplot(data = spec.df, mapping = aes(x = dilution, 
                                     y = specificity, 
                                     color = signature.sens)) +
  geom_point() +
  geom_smooth() +
  labs(title = "Specificity as a function of FFPE noise",
       x = "Percent of FFPE noise in samples",
       y = "Specificity value",
       color = "True signal") +
  coord_cartesian(xlim = c(0,100), ylim = c(0,1))
```

## File of all signatures diluted with FFPE noise

```{r}
#columns in data frame
sens = vector(mode = "list", length = length(signature.names))
spec = vector(mode = "list", length = length(signature.names))
signature = vector(mode = "list", length = length(signature.names))

#create data frame values 10 times
iteration.num = 3
for (iteration in 1:iteration.num){
  #iterate through each signature
  for (sig.num in 1:length(signature.names)){
    #store name of signature (once for every dilution)
    signature[[sig.num]] = append(signature[[sig.num]],
                                  rep(signature.names[sig.num], 5))
    #store values generated by get_classification_df for each dilution
    probabilities <- vector(mode = "list", length = 5)
    truth <- vector(mode = "list", length = 5)
    #initialize accumulator
    i = 1
      #each signature is diluted with 10%, 30%, 50%, 70%, and 90% FFPE noise
      # (1000 mutations total each time)
      for (x in c(100, 300, 500, 700, 900)){
        #create some percent of FFPE noise
        sample.ffpe <- create_signature_sample_vector(ffpe.signature, x)
        ffpe.truth <- rep("FFPE", x)
        #fill the rest with true signal
        sample <- create_signature_sample_vector(signature.matrix.list[[sig.num]], 1000-x)
        sample.truth <- rep(signature.names[sig.num], 1000-x)
        #evaluate using Bayes
        test <- get_classification_df(list(sample, sample.ffpe), 
                                      c(signature.names[sig.num],"FFPE"),
                                      list(signature.matrix.list[[sig.num]],
                                           ffpe.signature))
        #truth column turned into binary for ROCR package
        classification <- test %>%
          mutate(trueBinary = ifelse(truth == signature.names[sig.num],1,0))
        #store probabilities and truths for particular dilution
        probabilities[[i]] <- classification[[3]]
        truth[[i]] <- classification$trueBinary
        i = i + 1
      }
    #evaluate all 5 dilution samples
    pred = prediction(probabilities, truth)
    sens[[sig.num]] = append(sens[[sig.num]], evaluate_perf(100, 5, pred, "sens"))
    spec[[sig.num]] = append(spec[[sig.num]], evaluate_perf(100, 5, pred, "spec"))
  }
}

#vector indicating dilution amount
percent.FFPE = rep(c("10%", "30%", "50%", "70%", "90%"),
                   length(signature.names)*iteration.num)
#vectorize lists
signature = unlist(signature)
sens = unlist(sens)
spec = unlist(spec)

#convert into data frame
table = data.frame(percent.FFPE, signature, sens, spec)

#avg the multiple sensitivity/specificity values for each dilution and each signature
table <- table %>%
  group_by(percent.FFPE, signature) %>%
  summarize(sens = mean(sens, na.rm = TRUE),
            spec = mean(spec, na.rm = TRUE))
```

# Mutational load performance characteristics

## Mutational load predictions

```{r}
step_load = seq(50, 1000, by = 50)
MMR.probabilities <- vector(mode = "list", length = length(step))
MMR.truth <- vector(mode = "list", length = length(step))

for (x in 1:length(step)){
  sample.ffpe <- create_signature_sample_vector(ffpe.sig, step[x]/2)
  ffpe.truth <- rep("FFPE", step[x]/2)
  sample.sig6 <- create_signature_sample_vector(cosmic.sig6, step[x]/2)
  sig6.truth <- rep("MMR", step[x]/2)
  test <- get_classification_df(list(sample.sig6, sample.ffpe), c("MMR","FFPE"),
                                list(cosmic.sig6, ffpe.sig))
  classification <- test %>%
    mutate(trueBinary = ifelse(truth == "MMR",1,0))

  MMR.probabilities[[x]] <- classification$MMR
  MMR.truth[[x]] <- classification$trueBinary
}
```

```{r}
tob.probabilities <- vector(mode = "list", length = length(step))
tob.truth <- vector(mode = "list", length = length(step))

for (x in 1:length(step)){
  sample.ffpe <- create_signature_sample_vector(ffpe.sig, step[x]/2)
  ffpe.truth <- rep("FFPE", step[x]/2)
  sample.sig4 <- create_signature_sample_vector(cosmic.sig4, step[x]/2)
  sig4.truth <- rep("tob", step[x]/2)
  test <- get_classification_df(list(sample.sig4, sample.ffpe), c("Tobacco","FFPE"),
                                list(cosmic.sig4, ffpe.sig))
  classification <- test %>%
    mutate(trueBinary = ifelse(truth == "Tobacco",1,0))

  tob.probabilities[[x]] <- classification$Tobacco
  tob.truth[[x]] <- classification$trueBinary
}
```

```{r}
load.MMR <- prediction(MMR.probabilities, MMR.truth)
load.tob <- prediction(tob.probabilities, tob.truth)
```

## Sensitivity

```{r}
load.sens.MMR.vec = evaluate_perf(100, length(step_load), load.MMR, "sens")
load.sens.tob.vec = evaluate_perf(100, length(step_load), load.tob, "sens")
```

```{r}
#plot(step, load.sens.MMR.vec, ylim = c(0,1))
sensitivity = append(load.sens.MMR.vec, load.sens.tob.vec)
signature.sens = append(rep("MMR", length(load.sens.MMR.vec)),
                        rep("Tobacco", length(load.sens.tob.vec)))
dilution = append(step, step)
sens.df <- data.frame(dilution, sensitivity, signature.sens)

ggplot(data = sens.df, mapping = aes(x = dilution, 
                                     y = sensitivity, 
                                     color = signature.sens)) +
  geom_point() +
  geom_smooth() +
  labs(title = "Sensitivity as a function of mutational load",
       x = "Number of mutations in each sample",
       y = "Sensitivity value",
       color = "True signal") +
  coord_cartesian(ylim = c(0,1))
```

## Specificity

```{r}
load.spec.MMR.vec = evaluate_perf(100, length(step.load), load.MMR, "spec")
load.spec.tob.vec = evaluate_perf(100, length(step.load), load.tob, "spec")
```

```{r}
#plot(step, load.spec.MMR.vec, ylim = c(0,1))

specificity = append(load.spec.MMR.vec, load.spec.tob.vec)
signature.spec = append(rep("MMR", length(load.spec.MMR.vec)),
                        rep("Tobacco", length(load.spec.tob.vec)))
dilution = append(step, step)
spec.df <- data.frame(dilution, specificity, signature.spec)

ggplot(data = spec.df, mapping = aes(x = dilution, 
                                     y = specificity, 
                                     color = signature.spec)) +
  geom_point() +
  geom_smooth() +
  labs(title = "Specificity as a function of mutational load",
       x = "Number of mutations in each sample",
       y = "Specificity value",
       color = "True signal") +
  coord_cartesian(ylim = c(0,1))
```